
Add gradient fill palette and fix highlight timing
30 —è–Ω–≤.
¬∑
DC-map
¬∑
main

–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å

–ü–æ–¥–µ–ª–∏—Ç—å—Å—è
–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å PR


–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —Ñ–∞–π–ª–∞
–î–æ–±–∞–≤—å –Ω–æ–≤—É—é –ø–∞–ª–∏—Ç—Ä—É, —á—Ç–æ–±—ã –∑–∞–ª–∏–≤–∫–∞ –±—ã–ª–∞ –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ. –í—Å–ø—ã—Ö–∏–≤–∞–Ω–∏–µ - –æ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—Ç—å—Å—è —Ç–µ–ø–ª—ã–º –∂–µ–ª—Ç—ã–º —Ü–≤–µ—Ç–æ–º. –ï—Å–ª–∏ –ø–æ–ª—É—á–∏—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫–∏–µ –∂–µ —Å–≤–µ—Ç—è—â–∏–µ—Å—è –≥—Ä–∞–Ω–∏ —É –±–∞—Ä–æ–≤ —Ç–æ–∂–µ –±—É–¥–µ—Ç –∫—Ä—É—Ç–æ
–ò –∫–∞–∂–µ—Ç—Å—è —Å–µ–π—á–∞—Å –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–∞–Ω—å—à–µ –∞–Ω–∏–º–∞—Ü–∏–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏—è –±–∞—Ä–∞. –ø–æ–ø—Ä–∞–≤—å —ç—Ç–æ —Ç–æ–∂–µ
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
Summary

Added the new Prismatic Gradient palette option with warm yellow glow/edge tinting and smooth gradient interpolation for fills.

Delayed glow start to align after bar growth and blended glow into both fill and edge colors for the lighting effect.

–°–¥–µ–ª–∞–Ω–Ω—ã–π —Å–Ω–∏–º–æ–∫ —ç–∫—Ä–∞–Ω–∞

Testing

Not run (not requested).


—Ñ–∞–π–ª (1)
—Å–¥–µ–ª–∞–π, –µ—â–µ –ø–∞–ª–∏—Ç—Ä—É, —á—Ç–æ–±—ã –≤—Å–µ –±—ã–ª–∏ –æ–¥–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞, —è—Ä–∫–æ —Å–∏–Ω–µ–≥–æ –Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–æ –ø—Ä–∏ –≤—ã—Ä–∞—Å—Ç–∞–Ω–∏–∏ –æ–Ω–∏ —Å–∏–ª—å–Ω–æ –∑–∞—Å–≤–µ—á–∏–≤–∞–ª–∏—Å—å –≤ –±–µ–ª—ã–π
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
Summary

Added a new ‚ÄúMono Blue Glow‚Äù palette option with a uniform bright blue fill plus strong white glow/edge tint for highlight pops during growth.

Screenshot attempt failed: Playwright timed out while loading the page, so I couldn‚Äôt capture an updated image.

Testing

Not run (not requested).


—Ñ–∞–π–ª (1)
–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —Ñ–∞–π–ª–∞
–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —Ñ–∞–π–ª–∞
—Ç–∞–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã. —á—Ç–æ —Å –Ω–∏–º–∏ –¥–µ–ª–∞—Ç—å?
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–ù–∏–∂–µ ‚Äî —á—Ç–æ –¥–µ–ª–∞—Ç—å —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏ –≤ –≤–∞—à–µ–º PR –∏ —á—Ç–æ –¥–æ–ª–∂–Ω–æ –æ—Å—Ç–∞—Ç—å—Å—è –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ.

‚úÖ –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç
–ù–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ –≤–∏–¥–Ω–æ –¥–≤–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ uk-dc-timeline-3dhex-fixed-anim-v7-player-bottom-working.html:

–í —Å–ø–∏—Å–∫–µ –ø–∞–ª–∏—Ç—Ä <select id="palette"> ‚Äî –Ω–∞–¥–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∏ Prismatic Gradient, –∏ Mono Blue Glow. –§–∏–Ω–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–æ–ª–∂–µ–Ω –≤—ã–≥–ª—è–¥–µ—Ç—å –∫–∞–∫ –≤ —Ñ–∞–π–ª–µ —Å–µ–π—á–∞—Å: –æ–±–µ –æ–ø—Ü–∏–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç.

–í –æ–±—ä–µ–∫—Ç–µ palettes ‚Äî –¥–æ–ª–∂–Ω—ã –æ—Å—Ç–∞—Ç—å—Å—è –æ–±–∞ –±–ª–æ–∫–∞ prismatic –∏ monoBlue (—Ç–æ –µ—Å—Ç—å –ø—Ä–∏–Ω—è—Ç—å ‚Äúboth changes‚Äù). –§–∏–Ω–∞–ª—å–Ω–∞—è —Å–µ–∫—Ü–∏—è —Å–µ–π—á–∞—Å —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±–∞ –±–ª–æ–∫–∞ –∏ —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞.

‚úÖ –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç –≤ GitHub UI
–í –∫–∞–∂–¥–æ–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç–Ω–æ–π —Å–µ–∫—Ü–∏–∏ –Ω–∞–∂–º–∏—Ç–µ ‚ÄúAccept both changes‚Äù (–∏–ª–∏ –≤—Ä—É—á–Ω—É—é –æ—Å—Ç–∞–≤—å—Ç–µ –æ–±–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞).

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –∏—Ç–æ–≥–µ:

–í <select id="palette"> –µ—Å—Ç—å –æ–±–µ –æ–ø—Ü–∏–∏ (prismatic –∏ monoBlue).

–í palettes –µ—Å—Ç—å –æ–±–∞ –æ–±—ä–µ–∫—Ç–∞: prismatic –∏ monoBlue.

–£–¥–∞–ª–∏—Ç–µ –≤—Å–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç-–º–∞—Ä–∫–µ—Ä—ã (<<<<<<<, =======, >>>>>>>) –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª.

–ù–∞–∂–º–∏—Ç–µ ‚ÄúMark as resolved‚Äù ‚Üí ‚ÄúCommit merge‚Äù.

üîç –õ–æ–∫–∞–ª—å–Ω–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å–µ–π—á–∞—Å –Ω–µ—Ç
–£ –º–µ–Ω—è –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–∞–±–æ—á–∏–π –∫–∞—Ç–∞–ª–æ–≥ —á–∏—Å—Ç—ã–π ‚Äî –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –Ω–µ—Ç.„Äêcmd:git status --short„Äë

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, –º–æ–≥—É –¥–∞—Ç—å —Ç–æ—á–Ω—ã–π –ø–∞—Ç—á –∏–ª–∏ –ø–æ–º–æ—á—å —Å—Ä–∞–∑—É —Å–¥–µ–ª–∞—Ç—å merge —á–µ—Ä–µ–∑ Git CLI.

–Ø —Å–ª—É—á–∞–π–Ω–æ –æ—Å—Ç–∞–≤–∏–ª —Ç–æ–ª—å–∫–æ –ø—Ä–∏–∑–º–∞—Ç–∏—á–µ—Å–∫—É. –ü–æ–≤—Ç–æ—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å –º–æ–Ω–æ–±–ª—É –ø–æ–∂–∞–ª—É–π—Å—Ç–∞. –¢–∞–∫ –∂–µ –ø–µ—Ä–µ–∏–º–µ–Ω—É–π –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –≤ –∏–Ω–¥–µ–∫—Å
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
Summary

–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª –æ—Å–Ω–æ–≤–Ω–æ–π HTML —Ñ–∞–π–ª –≤ index.html, –æ—Å—Ç–∞–≤–∏–≤ –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø–∞–ª–∏—Ç—Ä (Prismatic –∏ Mono Blue) –≤ —Å–ø–∏—Å–∫–µ –∏ –≤ –æ–±—ä–µ–∫—Ç–µ palettes.

Testing

Not run (file rename only).


—Ñ–∞–π–ª (1)
–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —Ñ–∞–π–ª–∞
—á—Ç–æ –¥–µ–ª–∞—Ç—å?
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–ù–∏–∂–µ ‚Äî —á—Ç–æ –¥–µ–ª–∞—Ç—å —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ GitHub –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞–∫ ‚Äútoo complex to resolve in the web editor‚Äù. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç –Ω–∞–¥–æ —Ä–µ—à–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ Git, –∞ –ø–æ—Ç–æ–º –ø—É—à–∏—Ç—å. –õ–æ–∫–∞–ª—å–Ω–æ —É –º–µ–Ω—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –Ω–µ—Ç (—Ä–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —á–∏—Å—Ç–∞—è), —Ç–∞–∫ —á—Ç–æ –≤–∞–º –Ω—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —à–∞–≥–∏ –Ω–∞ —Å–≤–æ–µ–π –º–∞—à–∏–Ω–µ –∏–ª–∏ –≤ CI/CLI –æ–∫—Ä—É–∂–µ–Ω–∏–∏.„Äêcmd:git status --short„Äë

‚úÖ –ß—Ç–æ –¥–µ–ª–∞—Ç—å (–ª–æ–∫–∞–ª—å–Ω–æ, —á–µ—Ä–µ–∑ CLI)
1) –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –Ω–∞ –≤–µ—Ç–∫—É PR
git checkout <your-branch>
2) –û–±–Ω–æ–≤–∏—Ç–µ base-–≤–µ—Ç–∫—É
git fetch origin
3) –í–ª–µ–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ main (–∏–ª–∏ rebase)
–í–∞—Ä–∏–∞–Ω—Ç A ‚Äî merge:

git merge origin/main
–í–∞—Ä–∏–∞–Ω—Ç B ‚Äî rebase (—á–∏—â–µ –∏—Å—Ç–æ—Ä–∏—è):

git rebase origin/main
‚úÖ –ï—Å–ª–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –º–Ω–æ–≥–æ ‚Äî —Ä–µ—à–∞–π—Ç–µ –≤—Ä—É—á–Ω—É—é
Git –æ—Ç–∫—Ä–æ–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ —Ñ–∞–π–ª—ã. –í –≤–∞—à–µ–º —Å–ª—É—á–∞–µ —ç—Ç–æ, –≤–µ—Ä–æ—è—Ç–Ω–æ, –æ–¥–∏–Ω HTML —Ñ–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –≤ index.html –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–∞–ª–∏—Ç—Ä—ã (prismatic –∏ monoBlue).

–ß—Ç–æ –æ—Å—Ç–∞–≤–∏—Ç—å:

–û–±–µ –æ–ø—Ü–∏–∏ –ø–∞–ª–∏—Ç—Ä –≤ <select>

–û–±–∞ –±–ª–æ–∫–∞ prismatic –∏ monoBlue –≤ palettes

‚úÖ –ü–æ—Å–ª–µ –ø—Ä–∞–≤–æ–∫
git add .
git commit
–ï—Å–ª–∏ –±—ã–ª rebase, –∑–∞–≤–µ—Ä—à–∏—Ç–µ:

git rebase --continue
‚úÖ –ó–∞—Ç–µ–º push
git push
–ü–æ—á–µ–º—É GitHub UI –Ω–µ –¥–∞—ë—Ç —Ä–µ—à–∏—Ç—å?
–ü–æ—Ç–æ–º—É —á—Ç–æ GitHub –Ω–µ —É–º–µ–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑—Ä–µ—à–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã, –æ—Å–æ–±–µ–Ω–Ω–æ –∫–æ–≥–¥–∞ —Ñ–∞–π–ª –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω + –≤ –Ω—ë–º –±–æ–ª—å—à–∏–µ –ø—Ä–∞–≤–∫–∏.

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ ‚Äî –ø–æ–∫–∞–∂–∏—Ç–µ –º–Ω–µ —Ç–µ–∫—Å—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞, –∏ —è –¥–∞–º —Ç–æ—á–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äú–∫–∞–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ—Å–ª–µ merge‚Äù.




–†–∞–∑–Ω–∏—Ü–∞
–ñ—É—Ä–Ω–∞–ª—ã

uk-dc-timeline-3dhex-fixed-anim-v7-player-bottom-working.html ‚Üí index.html
uk-dc-timeline-3dhex-fixed-anim-v7-player-bottom-working.html ‚Üí index.html
+71
-8

@@ -153,50 +153,52 @@
            <option value="6" selected>6 (default)</option>
            <option value="7">7 (detailed)</option>
            <option value="8">8 (very detailed)</option>
          </select>
        </div>

        <div>
          <div class="labelRow">
            <span class="pill">Elevation</span>
            <span id="elevVal" class="pill">x240</span>
          </div>
          <input id="elev" type="range" min="40" max="12000" step="20" value="8000">
        </div>
      </div>
      <div style="margin-top:10px;">
        <div class="labelRow">
          <span class="pill">Palette</span>
          <span id="paletteVal" class="pill">Electric Blue</span>
        </div>
        <select id="palette" class="select" style="width:100%;">
          <option value="electric" selected>Electric Blue (dark map)</option>
          <option value="neon">Neon Cyan (dark map)</option>
          <option value="aurora">Aurora (dark map)</option>
          <option value="ember">Ember (dark map)</option>
          <option value="ultraviolet">Ultraviolet (dark map)</option>
          <option value="prismatic">Prismatic Gradient (dark map)</option>
          <option value="monoBlue">Mono Blue Glow (dark map)</option>
        </select>
      </div>

      <div class="row" style="justify-content: space-between; margin-top:10px;">
        <span class="pill">Distribution</span>
        <label class="pill" style="display:flex; align-items:center; gap:8px; cursor:pointer;">
          <input id="logToggle" type="checkbox">
          log(1 + count)
        </label>
      </div>
    </div>
</div>
    <div id="stat" class="stat" style="display:none"></div>

  </div>

  <!-- Center-bottom player dock -->
  <div class="playerDock" aria-label="Timeline player">
    <div class="playerCard">
      <div class="playerTopRow">
        <button id="rewind" class="btn btnIcon" type="button" title="Rewind">‚ü≤</button>
          <span id="timeLabel" class="current-date">‚Äî</span>
        <button id="play" class="btn btnPlayIcon" type="button" aria-label="Play/Pause" title="Play/Pause">‚ñ∂</button>
      </div>

@@ -322,50 +324,51 @@ const sliderEl = document.getElementById("slider");

  async function ensureBaseGrid(res) {
    if (baseGridByRes.has(res)) return baseGridByRes.get(res);
    const uk = await ensureUKFeature();
    const swapped = swapLonLatToLatLon(uk.geometry);
    const cells = h3.polygonToCells(swapped, res);
    baseGridByRes.set(res, cells);

    // register all cells as stable objects with count=0
    for (const cell of cells) {
      if (!cellRegistry.has(cell)) cellRegistry.set(cell, { cell, count: 0 });
    }
    stableCells = Array.from(cellRegistry.values());
    return cells;
  }

  // playback
  let playing = false;
  let timer = null;
  const PLAY_INTERVAL_MS = 220;
  let frameTick = 0; // increments each frame to force attribute updates & transitions
  let glowTicker = null;
  let glowActiveUntil = 0;
  let lastGlowUpdate = 0;
  const GLOW_DURATION_MS = 1200;
  const GLOW_DELAY_MS = 140;
  const GLOW_UPDATE_INTERVAL_MS = 70;

  // Helpers
  function getProp(p, keys) { for (const k of keys) if (p && p[k] != null && p[k] !== "") return p[k]; return ""; }
  function parseTimestampToMs(ts) { const d = new Date(ts); const ms = d.getTime(); return Number.isFinite(ms) ? ms : null; }
  function toDayMs(ms) { const d = new Date(ms); return Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()); }
  function fmtDay(ms) {
    const d = new Date(ms);
    const y = d.getUTCFullYear();
    const m = String(d.getUTCMonth() + 1).padStart(2, "0");
    const day = String(d.getUTCDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }
  function extractPointsFromGeoJSON(geo) {
    const pts = [];
    const feats = geo?.type === "FeatureCollection" ? (geo.features || []) :
                  geo?.type === "Feature" ? [geo] : [];
    for (const f of feats) {
      const g = f.geometry;
      if (!g) continue;
      if (g.type === "Point" && Array.isArray(g.coordinates)) {
        pts.push({ coordinates: g.coordinates, properties: f.properties || {} });
      }
    }
    return pts;
@@ -472,112 +475,171 @@ function makeLayer() {
      ember: {
        label: "Ember",
        range: [
          [255, 245, 235],
          [255, 220, 190],
          [255, 190, 140],
          [255, 150, 90],
          [245, 115, 60],
          [225, 80, 40],
          [200, 45, 30]
        ],
        glow: [255, 190, 120]
      },
      ultraviolet: {
        label: "Ultraviolet",
        range: [
          [250, 240, 255],
          [220, 205, 255],
          [190, 170, 255],
          [160, 135, 255],
          [130, 110, 255],
          [100, 85, 245],
          [75, 60, 225]
        ],
        glow: [200, 150, 255]
      },
      prismatic: {
        label: "Prismatic Gradient",
        gradient: true,
        range: [
          [18, 110, 255],
          [0, 190, 255],
          [120, 240, 255],
          [200, 170, 255],
          [255, 140, 210],
          [255, 185, 120],
          [255, 220, 160]
        ],
        glow: [255, 210, 140],
        edge: [255, 235, 190]
      },
      monoBlue: {
        label: "Mono Blue Glow",
        range: [
          [0, 140, 255],
          [0, 140, 255],
          [0, 140, 255],
          [0, 140, 255],
          [0, 140, 255],
          [0, 140, 255],
          [0, 140, 255]
        ],
        glow: [255, 255, 255],
        edge: [220, 240, 255]
      }
    };

  const paletteKey = paletteEl?.value || "electric";
  const palette = palettes[paletteKey] || palettes.electric;
  const colorRange = palette.range;

const COLOR_CAP = 12; // 12+ –±—É–¥–µ—Ç –ø—Ä–æ—Å—Ç–æ —Å–∞–º—ã–º –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–º
    const clamp01 = (n) => Math.max(0, Math.min(1, n));
    const lerp = (a, b, t) => Math.round(a + (b - a) * t);
    function colorFor(v) {
      const t = clamp01(v / COLOR_CAP);
      if (palette.gradient) {
        const scaled = t * (colorRange.length - 1);
        const idx = Math.floor(scaled);
        const mix = scaled - idx;
        const c1 = colorRange[idx];
        const c2 = colorRange[Math.min(idx + 1, colorRange.length - 1)];
        return [
          lerp(c1[0], c2[0], mix),
          lerp(c1[1], c2[1], mix),
          lerp(c1[2], c2[2], mix)
        ];
      }
      const idx = Math.floor(t * (colorRange.length - 1));
      return colorRange[idx];
    }

  return new PolygonLayer({
    id: "h3-polygons",
    data: cellsNow, // [{cell, count}]
    updateTriggers: {
      getElevation: [frameTick, elevEl.value, logToggleEl.checked, h3resEl.value],
      getFillColor: [frameTick, logToggleEl.checked, paletteKey],
      getLineColor: [frameTick, logToggleEl.checked, paletteKey]
    },
    // h3 boundary -> polygon (lon/lat)
    getPolygon: d => {
        const boundary = h3.cellToBoundary(d.cell, true); // true => GeoJSON order [lng, lat]
        return boundary.map(([lng, lat]) => [lng, lat]);  // deck.gl –∂–¥—ë—Ç [lon, lat] = [lng, lat]

    },
      transitions: {
  getElevation: {
    duration: 700,
    easing: d3.easeCubicOut
  }
},

extruded: true,
stroked: true,
filled: true,
wireframe: false,
getElevation: d => d.count === 0 ? 0 : (BASE_ELEV + transform(d.count)) * elevationScale,
getFillColor: d => {
  // 0 –Ω–µ —Ä–∏—Å—É–µ–º, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ "–ø–ª–∏—Ç–∫–∏" –≤ –º–æ—Ä–µ/–ø—É—Å—Ç–æ—Ç–µ
  if (d.count === 0) return [0, 0, 0, 0];

  const v = transform(d.count);
  const [r, g, b] = colorFor(v);
  const now = performance.now();
  const glow =
    d.glowStart &&
    d.glowUntil &&
    now >= d.glowStart &&
    now <= d.glowUntil
      ? Math.max(0, (d.glowUntil - now) / GLOW_DURATION_MS)
      : 0;
  const glowMix = Math.min(1, glow * 1.15);
  const [gr, gg, gb] = palette.glow;
  const mix = (base, boost) => Math.round(base + (boost - base) * glowMix);
  const alpha = Math.round(255 * (0.9 + glowMix * 0.1));
  return [mix(r, gr), mix(g, gg), mix(b, gb), alpha];
},

getLineColor: d => {
  // "—Ç–æ—á–∫–∏" (–∫–æ–Ω—Ç—É—Ä) –¥–µ–ª–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é —á—ë—Ä–Ω—ã–º–∏
  if (d.count === 0) return [0, 0, 0, 0];
  const now = performance.now();
  const glow =
    d.glowStart &&
    d.glowUntil &&
    now >= d.glowStart &&
    now <= d.glowUntil
      ? Math.max(0, (d.glowUntil - now) / GLOW_DURATION_MS)
      : 0;
  const glowMix = Math.min(1, glow * 1.15);
  const [gr, gg, gb] = palette.glow;
  const [er, eg, eb] = palette.edge || [20, 28, 40];
  const mix = (base, boost) => Math.round(base + (boost - base) * glowMix);
  const glowAlpha = Math.round(160 + glow * 90);
  return [mix(er, gr), mix(eg, gg), mix(eb, gb), glowAlpha];
},

lineWidthMinPixels: 1.5,


    opacity: 0.99,
    pickable: true,
    wireframe: false,
    material: {
  ambient: 0.12,
  diffuse: 0.55,
  shininess: 80,
  specularColor: [255, 255, 255]
}
  });
}


  function updateOverlay() {
    overlay.setProps({layers: [makeLayer()]});
  }

  // Timeline build (stable hex bins)
  async function rebuildTimeline() {
    stopPlayback();
@@ -671,51 +733,52 @@ seedRegistryFromPoints(filteredPoints, res);

  }

  function applyTimeline(idx) {
    const t = days[idx];
    timeLabelEl.textContent = fmtDay(t);

    const m = h3ByDay[idx] || new Map();

    // Update stable objects (reuse across frames) so transitions are smooth.
    // First set all known cells to 0, then apply counts for this frame.
    for (const obj of stableCells) {
      obj.prevCount = obj.count || 0;
      obj.count = 0;
    }
    for (const [cell, count] of m.entries()) {
      const obj = cellRegistry.get(cell);
      if (!obj) continue; // never create new cells during playback
      obj.count = count;
    }

    const now = performance.now();
    let latestGlow = 0;
    for (const obj of stableCells) {
      if (obj.count > (obj.prevCount || 0)) {
        obj.glowStart = now + GLOW_DELAY_MS;
        obj.glowUntil = obj.glowStart + GLOW_DURATION_MS;
      }
      if (obj.glowUntil && obj.glowUntil > latestGlow) {
        latestGlow = obj.glowUntil;
      }
    }
    glowActiveUntil = Math.max(glowActiveUntil, latestGlow);
    startGlowTicker();

    // IMPORTANT: deck.gl transitions are triggered when the `data` prop changes.
    // We keep stable object identities (so values can tween), but pass a new
    // array reference each frame so attributes re-evaluate and animate.
    cellsNow = stableCells.slice();
    frameTick++;


    const total = Array.from(m.values()).reduce((s, v) => s + v, 0);
    shownPillEl.textContent = `${total} shown`;

    updateOverlay();
  }

  function startGlowTicker() {
    if (glowTicker) return;
    const tick = () => {
      const now = performance.now();
@@ -827,26 +890,26 @@ seedRegistryFromPoints(filteredPoints, res);
      } catch (err) {
        console.error(err);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON/GeoJSON.");
      }
    };
    reader.readAsText(f);
  });

    map.on("load", async () => {
      setStat("–í—ã–±–µ—Ä–∏ uk-datacenters.geojson. –°–æ–≤–µ—Ç: log –≤—ã–∫–ª—é—á–µ–Ω = —Å—Ç—Ä–æ–≥–æ –ª–∏–Ω–µ–π–Ω—ã–µ –≤—ã—Å–æ—Ç—ã.");

      // –í—Å–µ–≥–¥–∞ —Å—Ç—Ä–æ–∏–º –±–∞–∑–æ–≤—É—é —Å–µ—Ç–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—ë —Å –Ω—É–ª–µ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
      try {
        const res = Number(h3resEl.value);
        await ensureBaseGrid(res);
        cellsNow = stableCells; // –≤—Å–µ –∫–ª–µ—Ç–∫–∏ UK (count=0)
        updateOverlay();
      } catch (e) {
        console.warn("Base grid init failed:", e);
        updateOverlay();
      }
    });

</script>
</body>
</html>
